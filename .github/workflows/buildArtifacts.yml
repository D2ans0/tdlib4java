
name: tdlib Main
on:
  push:
  workflow_dispatch:

env:
  java_ver: "8"
  php_ver: "7.4"
  cmake_ver: "3.16.x"
  VCPKG_DEFAULT_TRIPLET: "x64"
  vcpkg_packages: '"openssl:x64-windows-static-release", "zlib:x64-windows-static-release", "gperf:x64-windows-static-release", "readline:x64-windows-static-release"'


jobs:
  build:
    runs-on: Windows-latest
    steps:
    - uses: actions/checkout@v3


    - uses: microsoft/setup-msbuild@v1.1
    - name: Test MSbuild
      run: msbuild -version

    - uses: lukka/get-cmake@latest
    - name: Test Cmake
      run: cmake --version


    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v10
      with:
        vcpkgGitCommitId: '5568f110b509a9fd90711978a7cb76bae75bb092'
        vcpkgDirectory: C:/vcpkg

    - name: Install dependencies from vcpkg
      run: "C:/vcpkg/vcpkg.exe install ${{ env.vcpkg_packages }}"

    - run: find
      shell: bash


    - name: Setup Java 8
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: ${{ env.java_ver }}

    - name: Test Java
      run: "java -version"


    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.php_ver }}
        # tools: pecl
        # extensions: swoole

    - name: Test PHP
      run: "php -v"


    - name: Compile td with JNI support
      run: |
        Remove-Item td/build -Force -Recurse -ErrorAction SilentlyContinue
        mkdir td/build
        cmake -A x64 -DCMAKE_INSTALL_PREFIX:PATH=./td/example/java/td -DTD_ENABLE_JNI=ON -DCMAKE_TOOLCHAIN_FILE:FILEPATH=./td/vcpkg/scripts/buildsystems/vcpkg.cmake ./td
        cmake --build ./td/build --target install --config Release

    - name: Compile Java ver
      run: |
        Remove-Item td/example/java/build -Force -Recurse -ErrorAction SilentlyContinue
        mkdir td/example/java/build
        cmake -A x64 -DCMAKE_INSTALL_PREFIX:PATH=td/tdlib -DCMAKE_TOOLCHAIN_FILE:FILEPATH=td/vcpkg/scripts/buildsystems/vcpkg.cmake -DTd_DIR:PATH=$(Resolve-Path td/example/java/td/lib/cmake/Td) td/example/java
        cmake --build td/example/java/build --target install --config Release
        dir td/tdlib

    - name: Archive main td artifact
      uses: actions/upload-artifact@v3
      with:
        name: code-coverage-report
        path: ./td/build

    - name: Archive java artifact
      uses: actions/upload-artifact@v3
      with:
        name: code-coverage-report
        path: ./td/example/java/build
